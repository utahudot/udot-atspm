x-environment: &default-environment
  ASPNETCORE_ENVIRONMENT: "Development"
  ASPNETCORE_Kestrel__Certificates__Default__Password: "password"
  ASPNETCORE_Kestrel__Certificates__Default__Path: "/root/.aspnet/https/aspnetapp.pfx"
  ASPNETCORE_URLS: "https://+:5000"

  # Allowed Hosts
  AllowedHosts: "${ALLOWED_HOSTS}"

  # Database Connection Strings (Using Double Underscore Format)
  ConnectionStrings__ConfigContext__ConnectionString: "${CONFIG_CONNECTION}"
  ConnectionStrings__AggregationContext__ConnectionString: "${AGGREGATION_CONNECTION}"
  ConnectionStrings__EventLogContext__ConnectionString: "${EVENTLOG_CONNECTION}"
  ConnectionStrings__IdentityContext__ConnectionString: "${IDENTITY_CONNECTION}"

  # Database Providers
  ConnectionStrings__ConfigContext__Provider: "${ConfigContext_Provider}"
  ConnectionStrings__AggregationContext__Provider: "${AggregationContext_Provider}"
  ConnectionStrings__EventLogContext__Provider: "${EventLogContext_Provider}"
  ConnectionStrings__IdentityContext__Provider: "${IdentityContext_Provider}"

  # JWT Configuration
  Jwt__ExpireDays: "${JWT_EXPIRE_DAYS}"
  Jwt__Key: "${JWT_KEY}"
  Jwt__Issuer: "${JWT_ISSUER}"



services:
  speed-emitter-udp:
    build:
      context: .
      dockerfile: SpeedEventEmitter/Dockerfile
    environment:
      <<: *default-environment
      EVENT_LISTENER_HOST: eventlistener
      EVENT_LISTENER_PORT: "${EVENT_LISTENER_UDP_PORT}"
      EMITTER_PROTOCOL: udp
      EMITTER_INTERVAL_MS: "${EMITTER_INTERVAL_MS}"
    depends_on:
      eventlistener:
        condition: service_started

  speed-emitter-tcp:
    build:
      context: .
      dockerfile: SpeedEventEmitter/Dockerfile
    environment:
      <<: *default-environment
      EVENT_LISTENER_HOST: eventlistener
      EVENT_LISTENER_PORT: "${EVENT_LISTENER_TCP_PORT}"
      EMITTER_PROTOCOL: tcp
      EMITTER_INTERVAL_MS: "${EMITTER_INTERVAL_MS}"
    depends_on:
      eventlistener:
        condition: service_started

#   device-emulator:
#     build:
#       context: .
#       dockerfile: DeviceEmulator/Dockerfile
#     container_name: device-emulator
#     user: "1000:1000"
#     ports:
#       - "8080:80"
#     volumes:
#       - ftp_data:/files   #  Named volume instead of local folder
#       - ./DeviceEmulator/devices.json:/app/config/devices.json:ro
#     environment:
#       DEVICE_CONFIG_PATH: "/app/config/devices.json"
#       LOG_INTERVAL_MINUTES: 1
#     restart: unless-stopped

#   ftp-server:
#     image: stilliard/pure-ftpd:hardened
#     ports:
#       - "21:21"
#       - "30000-30109:30000-30109"
#     environment:
#       PUBLICHOST: "127.0.0.1"
#       FTP_USER_NAME: "ftpuser"
#       FTP_USER_PASS: "password"
#       FTP_USER_HOME: "/home/ftpuser"      
#       FTP_USER_UID: 1000
#       FTP_USER_GID: 1000
#       ADDED_FLAGS: "-c 100 -C 100 -d -E -R -p 30000:30109"
#     volumes:
#       - ftp_data:/home/ftpuser/files:rw 
#     restart: unless-stopped

        

#   sftp-server:
#     image: atmoz/sftp
#     ports:
#       - "2222:22"
#     volumes:
#       - ftp_data:/home/sftpuser/data:rw  #  Access shared logs
#     command: sftpuser:password:1001
#     restart: unless-stopped

# volumes:
#   ftp_data:
